import os

import numpy as np

from binara import internal_calculate_light_curve

# Python and the extension library each seem to have their own copy of OpenMP. This allows that during tests.
os.environ["KMP_DUPLICATE_LIB_OK"] = "TRUE"

def test_calculate_light_curve():
    # Parameters and sample light curve taken from a run of Gioula Kalapotharakos for TIC ID 110602878 sector 34.
    model_parameters = np.array([
        0.385886490907, 0.0664402461459, 0.728154, 0.398693367346, 0.0250731943869, -2.58470776396, 0.986066718147,
        -0.0495279552116, -1.02057860777, 0.368375172834, 0.275439743308, 0.0288241638398, 0.374759311771,
        0.922036025043, 1.61396897845, 0.113311357046, 0.242166052741, -1.42801281267, 1.40666171312, 0.650303472667,
        0.999811553496
    ], dtype=np.float64)
    model_phases = np.array([
        0.0178251167, 0.0534753500, 0.0891255833, 0.1247758167, 0.1604260500, 0.1960762833, 0.2317265167, 0.2673767500,
        0.3030269833, 0.3386772167, 0.3743274500, 0.4099776833, 0.4456279167, 0.4812781500, 0.5169283833, 0.5525786167,
        0.5882288500, 0.6238790833, 0.6595293167, 0.6951795500, 0.7308297833, 0.7664800167, 0.8021302500, 0.8377804833,
        0.8734307167, 0.9090809500, 0.9447311833, 0.9803814167, 1.0160316500, 1.0516818833, 1.0873321167, 1.1229823500,
        1.1586325833, 1.1942828167, 1.2299330500, 1.2655832833, 1.3012335167, 1.3368837500, 1.3725339833, 1.4081842167,
        1.4438344500, 1.4794846833, 1.5151349167, 1.5507851500, 1.5864353833, 1.6220856167, 1.6577358500, 1.6933860833,
        1.7290363167, 1.7646865500, 1.8003367833, 1.8359870167, 1.8716372500, 1.9072874833, 1.9429377167, 1.9785879500,
        2.0142381833, 2.0498884167, 2.0855386500, 2.1211888833, 2.1568391167, 2.1924893500, 2.2281395833, 2.2637898167,
        2.2994400500, 2.3350902833, 2.3707405167, 2.4063907500, 2.4420409833, 2.4776912167, 2.5133414500, 2.5489916833,
        2.5846419167, 2.6202921500, 2.6559423833, 2.6915926167, 2.7272428500, 2.7628930833, 2.7985433167, 2.8341935500,
        2.8698437833, 2.9054940167, 2.9411442500, 2.9767944833, 3.0124447167, 3.0480949500, 3.0837451833, 3.1193954167,
        3.1550456500, 3.1906958833, 3.2263461167, 3.2619963500, 3.2976465833, 3.3332968167, 3.3689470500, 3.4045972833,
        3.4402475167, 3.4758977500, 3.5115479833, 3.5471982167, 3.5828484500, 3.6184986833, 3.6541489167, 3.6897991500,
        3.7254493833, 3.7610996167, 3.7967498500, 3.8324000833, 3.8680503167, 3.9037005500, 3.9393507833, 3.9750010167,
        4.0106512500, 4.0463014833, 4.0819517167, 4.1176019500, 4.1532521833, 4.1889024167, 4.2245526500, 4.2602028833,
        4.2958531167, 4.3315033500, 4.3671535833, 4.4028038167, 4.4384540500, 4.4741042833, 4.5097545167, 4.5454047500,
        4.5810549833, 4.6167052167, 4.6523554500, 4.6880056833, 4.7236559167, 4.7593061500, 4.7949563833, 4.8306066167,
        4.8662568500, 4.9019070833, 4.9375573167, 4.9732075500, 5.0088577833, 5.0445080167, 5.0801582500, 5.1158084833,
        5.1514587167, 5.1871089500, 5.2227591833, 5.2584094167, 5.2940596500, 5.3297098833], dtype=np.float64)
    expected_model_fluxes = np.array([
        1.0000579, 1.0000938, 1.00013518, 1.00018309, 1.00023872, 1.00030341, 1.00037867, 1.00046609, 1.00056727,
        1.00068373, 1.00081667, 1.00096673, 1.00113365, 1.00131588, 1.00151018, 1.00171134, 1.00191207, 1.00210329,
        1.0022749, 1.00241696, 1.00252131, 1.00258296, 1.00260108, 1.0025791, 1.00252385, 1.00244403, 1.00234848,
        1.00224489, 1.002139, 1.00203449, 1.00193328, 0.99952513, 0.98726583, 0.98257857, 0.98249152, 0.98479929,
        0.99724601, 1.00131771, 1.00123872, 1.00116151, 1.00108621, 1.00101293, 1.00094183, 1.00087306, 1.00080674,
        1.00074296, 1.00068179, 1.00062329, 1.00056745, 1.00051427, 1.0004637, 1.0004157, 1.00037019, 1.00032711,
        1.00028635, 1.00024783, 1.00021146, 1.00017712, 1.00014473, 1.00011418, 1.00008539, 1.00005826, 1.0000327,
        1.00000862, 0.99998595, 0.9999646, 0.99994451, 0.9999256, 0.99990781, 0.99989107, 0.99987532, 0.99986052,
        0.99984661, 0.99983354, 0.99982127, 0.99980976, 0.99979895, 0.99978883, 0.99977935, 0.99977047, 0.99976218,
        0.99975444, 0.99974723, 0.99974052, 0.99973429, 0.99972851, 0.99972317, 0.99971825, 0.99971373, 0.99970959,
        0.99970582, 0.99970241, 0.99969934, 0.9996966, 0.99969418, 0.99969207, 0.99969026, 0.99968873, 0.99968749,
        0.99968652, 0.99968582, 0.99968538, 0.99968519, 0.99968525, 0.99968556, 0.9996861, 0.99968688, 0.9996879,
        0.99968914, 0.99969061, 0.9996923, 0.99969422, 0.99969636, 0.99969872, 0.99970129, 0.99970409, 0.99970711,
        0.99971034, 0.9997138, 0.99971749, 0.99972139, 0.99972553, 0.9997299, 0.9997345, 0.99973935, 0.99974444,
        0.99974979, 0.9997554, 0.99976129, 0.99976746, 0.99977393, 0.99978072, 0.99978786, 0.99979535, 0.99980324,
        0.99981155, 0.99982034, 0.99436095, 0.97074595, 0.94210245, 0.93188027, 0.929931, 0.93184467, 0.94251713,
        0.9712084, 0.99468027, 0.99995344, 0.99997495, 0.99999917, 1.0000266], dtype=np.float64)
    model_fluxes = internal_calculate_light_curve(model_phases, model_parameters)
    assert np.allclose(model_fluxes, expected_model_fluxes)
